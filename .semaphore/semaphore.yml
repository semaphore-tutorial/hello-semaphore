version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
blocks:
  - name: Build
    task:
      jobs:
        - name: go build
          commands:
            - checkout
            - go build -o hello-go main.go
            - artifact push workflow --force hello-go
      env_vars:
        - name: HELLO
          value: world
        - name: foo
          value: bar
  - name: Test
    task:
      jobs:
        - name: go test
          commands:
            - checkout
            - artifact pull workflow hello-go
            - go test -v
        - name: go lint
          commands:
            - checkout
            - go vet ./...
        - name: go list
          commands:
            - checkout
            - go list ./...
promotions:
  - name: Release
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: result = 'passed' AND tag =~ '.*'
